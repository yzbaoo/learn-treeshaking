{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: !0\n});\n\nvar e = require(\"./utils-fd988a1b.js\");\n\nfunction t(e) {\n  return e && \"object\" == typeof e && \"default\" in e ? e : {\n    default: e\n  };\n}\n\nvar r = t(require(\"cos-js-sdk-v5\"));\n\nfunction n(e, t) {\n  var r = Object.keys(e);\n\n  if (Object.getOwnPropertySymbols) {\n    var n = Object.getOwnPropertySymbols(e);\n    t && (n = n.filter(function (t) {\n      return Object.getOwnPropertyDescriptor(e, t).enumerable;\n    })), r.push.apply(r, n);\n  }\n\n  return r;\n}\n\nfunction o(t) {\n  for (var r = 1; r < arguments.length; r++) {\n    var o = null != arguments[r] ? arguments[r] : {};\n    r % 2 ? n(Object(o), !0).forEach(function (r) {\n      e.defineProperty(t, r, o[r]);\n    }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(t, Object.getOwnPropertyDescriptors(o)) : n(Object(o)).forEach(function (e) {\n      Object.defineProperty(t, e, Object.getOwnPropertyDescriptor(o, e));\n    });\n  }\n\n  return t;\n}\n\nexports.create = function (t) {\n  var n,\n      a = t.auth,\n      i = null,\n      u = null;\n\n  function c() {\n    return u || (u = new Promise(function (e, t) {\n      a().then(function (t) {\n        n = t;\n        var o = t.id,\n            a = t.key,\n            i = t.token,\n            u = t.startTime,\n            c = t.expiredTime,\n            f = new r.default({\n          getAuthorization: function (e, t) {\n            t({\n              TmpSecretId: o,\n              TmpSecretKey: a,\n              SecurityToken: i,\n              StartTime: u,\n              ExpiredTime: c\n            });\n          }\n        });\n        e(f);\n      }).catch(function (e) {\n        console.log(\"err\", e), t(e);\n      });\n    })), u;\n  }\n\n  function f() {\n    i = null, u = null;\n  }\n\n  function p(e, t) {\n    return s.apply(this, arguments);\n  }\n\n  function s() {\n    return (s = e.asyncToGenerator(e.regenerator.mark(function t(r, a) {\n      var u, s, l, b, d, y, m, h, P, O, x, g;\n      return e.regenerator.wrap(function (t) {\n        for (;;) switch (t.prev = t.next) {\n          case 0:\n            if (u = o({\n              pathPrefix: \"\",\n              datePrefix: !0,\n              rename: !0\n            }, r), i) {\n              t.next = 5;\n              break;\n            }\n\n            return t.next = 4, c();\n\n          case 4:\n            i = t.sent;\n\n          case 5:\n            return l = (s = n).region, b = s.bucketName, d = s.bucketContentPath, y = s.cdnUrl, m = u.file.name, u.rename && (h = -1 !== m.lastIndexOf(\".\") ? m.split(\".\").pop() : \"\", m = e.uuid() + (h ? \".\".concat(h) : \"\")), u.datePrefix && (P = new Date(), m = e.getDateFormatString(P) + \"/\" + m), u.pathPrefix && (m = e.formatApiPath(u.pathPrefix) + \"/\" + m), m = e.formatApiPath(d) + \"/\" + m, O = null, t.prev = 12, t.next = 15, new Promise(function (e, t) {\n              i.uploadFile({\n                Bucket: b,\n                Region: l,\n                Key: m,\n                SliceSize: 1073741824,\n                Body: r.file\n              }, function (r, n) {\n                n && e(n), r && t(r.error);\n              });\n            });\n\n          case 15:\n            O = t.sent, t.next = 26;\n            break;\n\n          case 18:\n            if (t.prev = 18, t.t0 = t.catch(12), console.error(\"There was an error uploading your file: \", t.t0), !(void 0 === a || a < 2)) {\n              t.next = 26;\n              break;\n            }\n\n            return f(), t.next = 25, p(r, \"number\" == typeof a ? a + 1 : 2);\n\n          case 25:\n            O = t.sent;\n\n          case 26:\n            if (!O) {\n              t.next = 31;\n              break;\n            }\n\n            return x = \"\", x = y ? e.formatApiPath(y) + \"/\" + m : \"https://\" + O.Location, g = r.file.size > 1073741824 ? null : JSON.parse(O.ETag), t.abrupt(\"return\", {\n              url: x,\n              md5: g\n            });\n\n          case 31:\n            return t.abrupt(\"return\", null);\n\n          case 32:\n          case \"end\":\n            return t.stop();\n        }\n      }, t, null, [[12, 18]]);\n    }))).apply(this, arguments);\n  }\n\n  return {\n    upload: p\n  };\n};","map":{"version":3,"mappings":"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","names":["config","credentials","auth","shareCOS","shareCOSPromise","createCOS","Promise","resolve","reject","then","data","TmpSecretId","id","TmpSecretKey","key","SecurityToken","token","startTime","expiredTime","cos","COS","getAuthorization","_options","callback","StartTime","ExpiredTime","err","console","log","resetCOS","upload","_upload","params","tryTimes","paramsWithDefault","_objectSpread","pathPrefix","datePrefix","rename","_context","region","_credentials","bucketName","bucketContentPath","cdnUrl","fileKey","file","name","extName","lastIndexOf","split","pop","uuid","now","Date","getDateFormatString","formatApiPath","result","uploadFile","Bucket","Region","Key","SliceSize","Body","error","t0","url","Location","md5","size","JSON","parse","ETag","stop"],"sources":["/Users/yzbaoo/Desktop/huohua/ilc-web-packages/packages/oss/src/cos.ts"],"sourcesContent":["/**\r\n * 腾讯云 cos 上传\r\n * https://cloud.tencent.com/document/product/436/11459\r\n */\r\nimport COS from 'cos-js-sdk-v5';\r\nimport { uuid, getDateFormatString, formatApiPath } from './utils';\r\nimport type { Config, Creator, Credentials, UploadParams, UploadResult } from './index';\r\n\r\nconst SLICE_SIZE = 1024 * 1024 * 1024;\r\nconst MAX_TRY_TIMES = 2; // 失败后尝试请求次数\r\n\r\nexport function create(config: Required<Config>): Creator {\r\n  \r\n  let credentials: Credentials;\r\n  const auth = config.auth;\r\n\r\n  let shareCOS: COS | null = null;\r\n  let shareCOSPromise: Promise<COS> | null = null;\r\n\r\n  function createCOS (): Promise<COS> {\r\n    if(!shareCOSPromise) {\r\n      shareCOSPromise =  new Promise((resolve, reject) => {\r\n        auth().then((data) => {\r\n          credentials = data;\r\n          const { id: TmpSecretId, key: TmpSecretKey, token: SecurityToken, startTime, expiredTime } = data;\r\n          const cos = new COS({\r\n            // eslint-disable-next-line @typescript-eslint/explicit-function-return-type\r\n            getAuthorization: (_options, callback) => {\r\n              callback({\r\n                TmpSecretId,\r\n                TmpSecretKey,\r\n                SecurityToken,\r\n                // 建议返回服务器时间作为签名的开始时间，避免用户浏览器本地时间偏差过大导致签名错误\r\n                StartTime: startTime, \r\n                ExpiredTime: expiredTime, \r\n            });\r\n            }\r\n          });\r\n          resolve(cos);\r\n        })\r\n        .catch((err) => {\r\n          console.log('err', err);\r\n          reject(err);\r\n        });\r\n      }) \r\n    }\r\n    return shareCOSPromise;\r\n  }\r\n  /**\r\n   * 重置 shareCOS 引用\r\n   */\r\n  function resetCOS(): void {\r\n    shareCOS = null;\r\n    shareCOSPromise = null;\r\n  }\r\n  /**\r\n   * 实现腾讯云上传\r\n   * @returns\r\n   */\r\n  async function upload(params: UploadParams, tryTimes?: number): Promise<UploadResult> {\r\n    const paramsWithDefault = {\r\n      pathPrefix: '',\r\n      datePrefix: true,\r\n      rename: true,\r\n      ...params,\r\n    };\r\n    if(!shareCOS) {\r\n      shareCOS = await createCOS();\r\n    }\r\n    const {region, bucketName, bucketContentPath, cdnUrl} = credentials;\r\n\r\n    // 处理上传文件名\r\n    // let fileKey = encodeURIComponent(paramsWithDefault.file.name);\r\n    let fileKey = paramsWithDefault.file.name; // cos内部已经encode了，重复encode会导致上传中文文件名不可用\r\n    if (paramsWithDefault.rename) {\r\n      const extName = fileKey.lastIndexOf('.') !== -1 ? fileKey.split('.').pop() : '';\r\n      fileKey = uuid() + (extName ? `.${extName}` : '');\r\n    }\r\n    if (paramsWithDefault.datePrefix) {\r\n      const now = new Date();\r\n      fileKey = getDateFormatString(now) + '/' + fileKey;\r\n    }\r\n    if (paramsWithDefault.pathPrefix) {\r\n      fileKey = formatApiPath(paramsWithDefault.pathPrefix) + '/' + fileKey;\r\n    }\r\n    fileKey = formatApiPath(bucketContentPath) + '/' + fileKey;\r\n\r\n    let result: any = null;\r\n    try {\r\n      result = await new Promise((resolve, reject) => {\r\n        (shareCOS as COS).uploadFile({\r\n          Bucket: bucketName,              // 填入您自己的存储桶，必须字段 \r\n          Region: region,               // 存储桶所在地域，必须字段\r\n          Key: fileKey,                     // 存储在桶里的对象键（例如1.jpg，a/b/test.txt），必须字段\r\n          SliceSize: SLICE_SIZE,            // 触发分块上传的阈值，默认1GB; 超过1GB使用分块上传，非必须\r\n          Body: params.file, \r\n        }, (err: COS.CosError, data: COS.UploadFileResult) => {\r\n          if(data) resolve(data);\r\n          if(err) reject(err.error);\r\n        });\r\n      })\r\n    } catch (err) {\r\n      console.error('There was an error uploading your file: ', err);\r\n      if (typeof tryTimes === 'undefined' || tryTimes < MAX_TRY_TIMES) {\r\n        resetCOS();\r\n        result = await upload(params, typeof tryTimes === 'number' ? tryTimes + 1 : 2);\r\n      }\r\n    }\r\n    if (result) {\r\n      let url = '';\r\n      if(cdnUrl) {\r\n        url = formatApiPath(cdnUrl) + '/' + fileKey;\r\n      }else {\r\n        url = 'https://' + result.Location; \r\n      }\r\n      // 临时获取md5方案： 不触发分块上传取ETag，触发后置为null\r\n      const md5 =  params.file.size > SLICE_SIZE ? null : JSON.parse(result.ETag);\r\n\r\n      return {url, md5}; \r\n    }\r\n    return null;\r\n  }\r\n\r\n  return {\r\n    upload\r\n  };\r\n}"]},"metadata":{},"sourceType":"script"}