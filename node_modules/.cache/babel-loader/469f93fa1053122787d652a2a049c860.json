{"ast":null,"code":"var util = require('./util'); // 按照文件特征值，缓存 UploadId\n\n\nvar cacheKey = 'cos_sdk_upload_cache';\nvar expires = 30 * 24 * 3600;\nvar cache;\nvar timer;\n\nvar getCache = function () {\n  try {\n    var val = JSON.parse(localStorage.getItem(cacheKey));\n  } catch (e) {}\n\n  if (!val) val = [];\n  cache = val;\n};\n\nvar setCache = function () {\n  try {\n    localStorage.setItem(cacheKey, JSON.stringify(cache));\n  } catch (e) {}\n};\n\nvar init = function () {\n  if (cache) return;\n  getCache.call(this); // 清理太老旧的数据\n\n  var changed = false;\n  var now = Math.round(Date.now() / 1000);\n\n  for (var i = cache.length - 1; i >= 0; i--) {\n    var mtime = cache[i][2];\n\n    if (!mtime || mtime + expires < now) {\n      cache.splice(i, 1);\n      changed = true;\n    }\n  }\n\n  changed && setCache();\n}; // 把缓存存到本地\n\n\nvar save = function () {\n  if (timer) return;\n  timer = setTimeout(function () {\n    setCache();\n    timer = null;\n  }, 400);\n};\n\nvar mod = {\n  using: {},\n  // 标记 UploadId 正在使用\n  setUsing: function (uuid) {\n    mod.using[uuid] = true;\n  },\n  // 标记 UploadId 已经没在使用\n  removeUsing: function (uuid) {\n    delete mod.using[uuid];\n  },\n  // 用上传参数生成哈希值\n  getFileId: function (file, ChunkSize, Bucket, Key) {\n    if (file.name && file.size && file.lastModifiedDate && ChunkSize) {\n      return util.md5([file.name, file.size, file.lastModifiedDate, ChunkSize, Bucket, Key].join('::'));\n    } else {\n      return null;\n    }\n  },\n  // 获取文件对应的 UploadId 列表\n  getUploadIdList: function (uuid) {\n    if (!uuid) return null;\n    init.call(this);\n    var list = [];\n\n    for (var i = 0; i < cache.length; i++) {\n      if (cache[i][0] === uuid) list.push(cache[i][1]);\n    }\n\n    return list.length ? list : null;\n  },\n  // 缓存 UploadId\n  saveUploadId: function (uuid, UploadId, limit) {\n    init.call(this);\n    if (!uuid) return; // 清理没用的 UploadId，js 文件没有 FilePath ，只清理相同记录\n\n    for (var i = cache.length - 1; i >= 0; i--) {\n      var item = cache[i];\n\n      if (item[0] === uuid && item[1] === UploadId) {\n        cache.splice(i, 1);\n      }\n    }\n\n    cache.unshift([uuid, UploadId, Math.round(Date.now() / 1000)]);\n    if (cache.length > limit) cache.splice(limit);\n    save();\n  },\n  // UploadId 已用完，移除掉\n  removeUploadId: function (UploadId) {\n    init.call(this);\n    delete mod.using[UploadId];\n\n    for (var i = cache.length - 1; i >= 0; i--) {\n      if (cache[i][1] === UploadId) cache.splice(i, 1);\n    }\n\n    save();\n  }\n};\nmodule.exports = mod;","map":{"version":3,"names":["util","require","cacheKey","expires","cache","timer","getCache","val","JSON","parse","localStorage","getItem","e","setCache","setItem","stringify","init","call","changed","now","Math","round","Date","i","length","mtime","splice","save","setTimeout","mod","using","setUsing","uuid","removeUsing","getFileId","file","ChunkSize","Bucket","Key","name","size","lastModifiedDate","md5","join","getUploadIdList","list","push","saveUploadId","UploadId","limit","item","unshift","removeUploadId","module","exports"],"sources":["/Users/yzbaoo/Desktop/huohua/ilc-web-packages/node_modules/cos-js-sdk-v5/src/session.js"],"sourcesContent":["var util = require('./util');\n\n// 按照文件特征值，缓存 UploadId\nvar cacheKey = 'cos_sdk_upload_cache';\nvar expires = 30 * 24 * 3600;\nvar cache;\nvar timer;\n\nvar getCache = function () {\n    try {\n        var val = JSON.parse(localStorage.getItem(cacheKey));\n    } catch (e) {\n    }\n    if (!val) val = [];\n    cache = val;\n};\nvar setCache = function () {\n    try {\n        localStorage.setItem(cacheKey, JSON.stringify(cache))\n    } catch (e) {\n    }\n};\n\nvar init = function () {\n    if (cache) return;\n    getCache.call(this);\n    // 清理太老旧的数据\n    var changed = false;\n    var now = Math.round(Date.now() / 1000);\n    for (var i = cache.length - 1; i >= 0; i--) {\n        var mtime = cache[i][2];\n        if (!mtime || mtime + expires < now) {\n            cache.splice(i, 1);\n            changed = true;\n        }\n    }\n    changed && setCache();\n};\n\n// 把缓存存到本地\nvar save = function () {\n    if (timer) return;\n    timer = setTimeout(function () {\n        setCache();\n        timer = null;\n    }, 400);\n};\n\nvar mod = {\n    using: {},\n    // 标记 UploadId 正在使用\n    setUsing: function (uuid) {\n        mod.using[uuid] = true;\n    },\n    // 标记 UploadId 已经没在使用\n    removeUsing: function (uuid) {\n        delete mod.using[uuid];\n    },\n    // 用上传参数生成哈希值\n    getFileId: function (file, ChunkSize, Bucket, Key) {\n        if (file.name && file.size && file.lastModifiedDate && ChunkSize) {\n            return util.md5([file.name, file.size, file.lastModifiedDate, ChunkSize, Bucket, Key].join('::'));\n        } else {\n            return null;\n        }\n    },\n    // 获取文件对应的 UploadId 列表\n    getUploadIdList: function (uuid) {\n        if (!uuid) return null;\n        init.call(this);\n        var list = [];\n        for (var i = 0; i < cache.length; i++) {\n            if (cache[i][0] === uuid)\n                list.push(cache[i][1]);\n        }\n        return list.length ? list : null;\n    },\n    // 缓存 UploadId\n    saveUploadId: function (uuid, UploadId, limit) {\n        init.call(this);\n        if (!uuid) return;\n        // 清理没用的 UploadId，js 文件没有 FilePath ，只清理相同记录\n        for (var i = cache.length - 1; i >= 0; i--) {\n            var item = cache[i];\n            if (item[0] === uuid && item[1] === UploadId) {\n                cache.splice(i, 1);\n            }\n        }\n        cache.unshift([uuid, UploadId, Math.round(Date.now() / 1000)]);\n        if (cache.length > limit) cache.splice(limit);\n        save();\n    },\n    // UploadId 已用完，移除掉\n    removeUploadId: function (UploadId) {\n        init.call(this);\n        delete mod.using[UploadId];\n        for (var i = cache.length - 1; i >= 0; i--) {\n            if (cache[i][1] === UploadId) cache.splice(i, 1)\n        }\n        save();\n    },\n};\n\nmodule.exports = mod;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}